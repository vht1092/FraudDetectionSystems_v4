package com.fds.views;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.security.authentication.AuthenticationManager;
import org.springframework.security.authentication.UsernamePasswordAuthenticationToken;
import org.springframework.security.core.Authentication;
import org.springframework.security.core.AuthenticationException;
import org.springframework.security.core.context.SecurityContextHolder;

import com.fds.SecurityUtils;
import com.fds.components.LoginForm;
import com.fds.services.SysTaskService;
import com.vaadin.annotations.Theme;
import com.vaadin.annotations.VaadinServletConfiguration;
import com.vaadin.navigator.Navigator;
import com.vaadin.server.Page;
import com.vaadin.server.VaadinRequest;
import com.vaadin.server.VaadinService;
import com.vaadin.spring.annotation.SpringUI;
import com.vaadin.spring.navigator.SpringViewProvider;
import com.vaadin.ui.UI;

@SpringUI
@Theme("mytheme")
public class MainUI extends UI {

	private static final Logger LOGGER = LoggerFactory.getLogger(MainUI.class);

	private static final long serialVersionUID = 1383791387363344726L;
	@Autowired
	private ErrorView errorView;
	@Autowired
	public SpringViewProvider viewProvider;
	@Autowired
	private SysTaskService sysTaskService;
	@Value("${time.refresh.content}")
	private int sTimeRefreshContent;
	@Autowired
	private AuthenticationManager authentionManager;

	@Override
	protected void init(VaadinRequest request) {
		if (!SecurityUtils.isLoggedIn()) {
			showLogin();
		} else {
			showMainForm();
		}

		addDetachListener(new DetachListener() {
			private static final long serialVersionUID = 1L;

			@Override
			public void detach(DetachEvent event) {
				// Xoa tat ca cac case dang xu da duoc dang ky
				sysTaskService.delete(SecurityUtils.getUserId(), "CASEDETAIL");				
				getSession().close();
			}
		});
	}

	private void showLogin() {
		setContent(new LoginForm(this::login));
	}

	private void showMainForm() {
		Navigator navigator = new Navigator(this, this);
		navigator.setErrorView(errorView);
		navigator.addProvider(viewProvider);
		viewProvider.setAccessDeniedViewClass(AccessDeniedView.class);
		getUI().getNavigator().navigateTo("");
	}

	private boolean login(final String username, final String password) {
		try {
			Authentication token = authentionManager.authenticate(new UsernamePasswordAuthenticationToken(username, password));
			VaadinService.reinitializeSession(VaadinService.getCurrentRequest());
			SecurityContextHolder.getContext().setAuthentication(token);
			getUI().setPollInterval(sTimeRefreshContent);
			LOGGER.info(username + " login successful");
			showMainForm();
			return true;
		} catch (AuthenticationException ex) {
			LOGGER.error(username + " login - " + ex.getMessage());
			return false;
		}
	}

	// public void detach(DetachEvent event) {
	// // Xoa tat ca cac case dang xu da duoc dang ky
	// sysTaskService.delete(SecurityUtils.getUserId(), "CASEDETAIL");
	// //getSession().close();
	// System.out.println("Detach");
	// }

}
